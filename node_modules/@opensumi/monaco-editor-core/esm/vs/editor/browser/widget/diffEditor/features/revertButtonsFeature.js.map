{"version":3,"sources":["vs/editor/browser/widget/diffEditor/features/revertButtonsFeature.ts"],"names":[],"mappings":"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","file":"revertButtonsFeature.js","sourceRoot":"file:///workspaces/monaco-editor-core/out-editor-esm","sourcesContent":["/*---------------------------------------------------------------------------------------------\n *  Copyright (c) Microsoft Corporation. All rights reserved.\n *  Licensed under the MIT License. See License.txt in the project root for license information.\n *--------------------------------------------------------------------------------------------*/\n\nimport { addDisposableListener, h, EventType } from '../../../../../base/browser/dom';\nimport { renderIcon } from '../../../../../base/browser/ui/iconLabel/iconLabels';\nimport { Codicon } from '../../../../../base/common/codicons';\nimport { Disposable, toDisposable } from '../../../../../base/common/lifecycle';\nimport { IObservable, autorunWithStore, derived } from '../../../../../base/common/observable';\nimport { IGlyphMarginWidget, IGlyphMarginWidgetPosition } from '../../../editorBrowser';\nimport { DiffEditorEditors } from '../components/diffEditorEditors';\nimport { DiffEditorOptions } from '../diffEditorOptions';\nimport { DiffEditorViewModel } from '../diffEditorViewModel';\nimport { DiffEditorWidget } from '../diffEditorWidget';\nimport { LineRange, LineRangeSet } from '../../../../common/core/lineRange';\nimport { Range } from '../../../../common/core/range';\nimport { RangeMapping } from '../../../../common/diff/rangeMapping';\nimport { GlyphMarginLane } from '../../../../common/model';\nimport { localize } from '../../../../../nls';\n\nconst emptyArr: never[] = [];\n\nexport class RevertButtonsFeature extends Disposable {\n\tconstructor(\n\t\tprivate readonly _editors: DiffEditorEditors,\n\t\tprivate readonly _diffModel: IObservable<DiffEditorViewModel | undefined>,\n\t\tprivate readonly _options: DiffEditorOptions,\n\t\tprivate readonly _widget: DiffEditorWidget\n\t) {\n\t\tsuper();\n\n\t\tthis._register(autorunWithStore((reader, store) => {\n\t\t\tif (!this._options.shouldRenderRevertArrows.read(reader)) { return; }\n\t\t\tconst model = this._diffModel.read(reader);\n\t\t\tconst diff = model?.diff.read(reader);\n\t\t\tif (!model || !diff) { return; }\n\t\t\tif (model.movedTextToCompare.read(reader)) { return; }\n\n\t\t\tconst glyphWidgetsModified: IGlyphMarginWidget[] = [];\n\n\t\t\tconst selectedDiffs = this._selectedDiffs.read(reader);\n\t\t\tconst selectedDiffsSet = new Set(selectedDiffs.map(d => d.mapping));\n\n\t\t\tif (selectedDiffs.length > 0) {\n\t\t\t\t// The button to revert the selection\n\t\t\t\tconst selections = this._editors.modifiedSelections.read(reader);\n\n\t\t\t\tconst btn = store.add(new RevertButton(\n\t\t\t\t\tselections[selections.length - 1].positionLineNumber,\n\t\t\t\t\tthis._widget,\n\t\t\t\t\tselectedDiffs.flatMap(d => d.rangeMappings),\n\t\t\t\t\ttrue\n\t\t\t\t));\n\t\t\t\tthis._editors.modified.addGlyphMarginWidget(btn);\n\t\t\t\tglyphWidgetsModified.push(btn);\n\t\t\t}\n\n\t\t\tfor (const m of diff.mappings) {\n\t\t\t\tif (selectedDiffsSet.has(m)) { continue; }\n\t\t\t\tif (!m.lineRangeMapping.modified.isEmpty && m.lineRangeMapping.innerChanges) {\n\t\t\t\t\tconst btn = store.add(new RevertButton(\n\t\t\t\t\t\tm.lineRangeMapping.modified.startLineNumber,\n\t\t\t\t\t\tthis._widget,\n\t\t\t\t\t\tm.lineRangeMapping.innerChanges,\n\t\t\t\t\t\tfalse\n\t\t\t\t\t));\n\t\t\t\t\tthis._editors.modified.addGlyphMarginWidget(btn);\n\t\t\t\t\tglyphWidgetsModified.push(btn);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tstore.add(toDisposable(() => {\n\t\t\t\tfor (const w of glyphWidgetsModified) {\n\t\t\t\t\tthis._editors.modified.removeGlyphMarginWidget(w);\n\t\t\t\t}\n\t\t\t}));\n\t\t}));\n\t}\n\n\tprivate readonly _selectedDiffs = derived(this, (reader) => {\n\t\t/** @description selectedDiffs */\n\t\tconst model = this._diffModel.read(reader);\n\t\tconst diff = model?.diff.read(reader);\n\t\t// Return `emptyArr` because it is a constant. [] is always a new array and would trigger a change.\n\t\tif (!diff) { return emptyArr; }\n\n\t\tconst selections = this._editors.modifiedSelections.read(reader);\n\t\tif (selections.every(s => s.isEmpty())) { return emptyArr; }\n\n\t\tconst selectedLineNumbers = new LineRangeSet(selections.map(s => LineRange.fromRangeInclusive(s)));\n\n\t\tconst selectedMappings = diff.mappings.filter(m =>\n\t\t\tm.lineRangeMapping.innerChanges && selectedLineNumbers.intersects(m.lineRangeMapping.modified)\n\t\t);\n\t\tconst result = selectedMappings.map(mapping => ({\n\t\t\tmapping,\n\t\t\trangeMappings: mapping.lineRangeMapping.innerChanges!.filter(\n\t\t\t\tc => selections.some(s => Range.areIntersecting(c.modifiedRange, s))\n\t\t\t)\n\t\t}));\n\t\tif (result.length === 0 || result.every(r => r.rangeMappings.length === 0)) { return emptyArr; }\n\t\treturn result;\n\t});\n}\n\nexport class RevertButton extends Disposable implements IGlyphMarginWidget {\n\tpublic static counter = 0;\n\n\tprivate readonly _id: string = `revertButton${RevertButton.counter++}`;\n\n\tgetId(): string { return this._id; }\n\n\tprivate readonly _domNode = h('div.revertButton', {\n\t\ttitle: this._revertSelection\n\t\t\t? localize('revertSelectedChanges', 'Revert Selected Changes')\n\t\t\t: localize('revertChange', 'Revert Change')\n\t},\n\t\t[renderIcon(Codicon.arrowRight)]\n\t).root;\n\n\tconstructor(\n\t\tprivate readonly _lineNumber: number,\n\t\tprivate readonly _widget: DiffEditorWidget,\n\t\tprivate readonly _diffs: RangeMapping[],\n\t\tprivate readonly _revertSelection: boolean,\n\t) {\n\t\tsuper();\n\n\n\t\tthis._register(addDisposableListener(this._domNode, EventType.MOUSE_DOWN, e => {\n\t\t\t// don't prevent context menu from showing up\n\t\t\tif (e.button !== 2) {\n\t\t\t\te.stopPropagation();\n\t\t\t\te.preventDefault();\n\t\t\t}\n\t\t}));\n\n\t\tthis._register(addDisposableListener(this._domNode, EventType.MOUSE_UP, e => {\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}));\n\n\t\tthis._register(addDisposableListener(this._domNode, EventType.CLICK, (e) => {\n\t\t\tthis._widget.revertRangeMappings(this._diffs);\n\t\t\te.stopPropagation();\n\t\t\te.preventDefault();\n\t\t}));\n\t}\n\n\t/**\n\t * Get the dom node of the glyph widget.\n\t */\n\tgetDomNode(): HTMLElement {\n\t\treturn this._domNode;\n\t}\n\n\t/**\n\t * Get the placement of the glyph widget.\n\t */\n\tgetPosition(): IGlyphMarginWidgetPosition {\n\t\treturn {\n\t\t\tlane: GlyphMarginLane.Right,\n\t\t\trange: {\n\t\t\t\tstartColumn: 1,\n\t\t\t\tstartLineNumber: this._lineNumber,\n\t\t\t\tendColumn: 1,\n\t\t\t\tendLineNumber: this._lineNumber,\n\t\t\t},\n\t\t\tzIndex: 10001,\n\t\t};\n\t}\n}\n"]}